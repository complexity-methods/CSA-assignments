---
title: "DCS Assignments Part 4"
author: "Fred Hasselman, Maarten Wijnants & Merlijn Olthof"
date: "1/14/2018"
output: 
  bookdown::html_document2: 
    variant: markdown+hard_line_breaks
    fig_caption: yes
    highlight: pygments
    keep_md: yes
    number_sections: yes
    theme: spacelab
    toc: yes
    toc_float: true
    collapsed: false
    smooth_scroll: true
    code_folding: show
    bibliography: [refs.bib, packages.bib]
    biblio-style: apalike
    csl: apa.csl
    includes:
        before_body: assignmentstyle.html
    pandoc_args: ["--number-offset","7"]
    
---


```{r, include=FALSE}
knitr::opts_chunk$set(include=TRUE, tidy = FALSE, warning = FALSE, message = FALSE)
```


# **Quick Links** {-}

* [Main Assignments Page](https://darwin.pwo.ru.nl/skunkworks/courseware/1718_DCS/assignments/)
* [Assignments Part 1A: Introduction to the mathematics of change](https://darwin.pwo.ru.nl/skunkworks/courseware/1718_DCS/assignments/ASSIGNMENTS_P1A.html)
* [Assignments Part 1B: Fitting Parameters and Potential Functions](https://darwin.pwo.ru.nl/skunkworks/courseware/1718_DCS/assignments/ASSIGNMENTS_P1B.html)
* [Assignments Part 2: Time Series Analysis: Temporal Correlations and Fractal Scaling](https://darwin.pwo.ru.nl/skunkworks/courseware/1718_DCS/assignments/ASSIGNMENTS_P2.html)
* [Assignments Part 3: Quantifying Recurrences in State Space](https://darwin.pwo.ru.nl/skunkworks/courseware/1718_DCS/assignments/ASSIGNMENTS_P3.html)
  
</br>
</br>


# **Early Warning Signals and Complex Networks**


## **Early Warning Signals in a Clinical Case Study**

Dynamic assessment (e.g. ecological momentary assesment) is increasingly used in the mental health field. Process monitoring with dynamic assessment can empower patients and benefit self-insight (van Os et al., 2017). Additionally, ecological momentary assesment (EMA) time series can be analysed and the results can be used to inform the treatment process. 
In this assignment, we will use complex systems theory and methodology to perform a quantitative case study for a real patient. 

### First Steps {.tabset .tabset-fade .tabset-pills}

You will analyse EMA data from a patient who received impatient psychotherapy for mood disorders. The patient answered questions from the therapy process questionnaire on a daily basis for the full 101 days of his treatment. 
The learning objectives of the assignments are as follows:
1) You can interpret plots of raw EMA time series, as well as complexity resonance diagrams and critical instability diagrams of EMA time series.
2) You can describe what possible change processes in complex systems could explain the quantitative results from the case study. 


#### Questions {-}

* Open R and load the data 'clinical.case.study.csv' to a data frame called df.  The data file is on [Github](https://github.com/FredHasselman/The-Complex-Systems-Approach-Book/blob/master/assignments/assignment_data/EarlyWarningSignals/clinical.case.study.csv)
* Look at the data frame. Where is time in this data? In the rows or the columns?
* Add a time variable called 'days' to the data frame. 
* Factor 7 yields the scores on *Impairment by Symptoms and Problems* for this patient on each day. 
    + Plot the time series.
    + What pattern do you see?


#### Answers {-}


* Open R and load the data 'clinical.case.study.csv' to a data frame called df.  The data file is on [Github](https://github.com/FredHasselman/The-Complex-Systems-Approach-Book/blob/master/assignments/assignment_data/EarlyWarningSignals/clinical.case.study.csv)


```{r}
library(rio)
df <- import("https://raw.githubusercontent.com/FredHasselman/The-Complex-Systems-Approach-Book/master/assignments/assignment_data/EarlyWarningSignals/clinical.case.study.csv")

```

* Look at the data frame. Where is time in this data? In the rows or the columns?

> In the rows.

* Add a time variable called 'days' to the data frame. 

```{r}
df$days <- (1:nrow(df))
```

* Factor 7 yields the scores on *Impairment by Symptoms and Problems* for this patient on each day. 
    + Plot the time series.
    + What pattern do you see?

```{r}
plot(df$days, df$factor7, type='l')
```


### Phase Transitions and Early-Warning Signals {.tabset .tabset-fade .tabset-pills}

Before we continue, read this short summary of what you (should) know about phase transitions and early-warning signals: 

```{block2,type="rmdkennen"}
Change from one attractor to another is called a phase transition. Phase transitions are preceded by a destabilization period in which the stability of the existing state decreases (as a consequence of increasing control parameters). During destabilization, the system loses its resilience to external influences leading to increased fluctuations and disorder in the systems behaviour (critical fluctuations) and an increased return time to the existing state after perturbation (critical slowing down). Destabilization ends abruptly when the system makes a phase transition towards a new stable state. Critical fluctuations and critical slowing down can therefore serve as early-warning signals (EWS) for phase transitions. 
```

#### Questions {-}

Answer the following questions, please think and discuss with your neighbours before turning to the answers. You can use the literature and what you've learned in the lecture:

* Can you think of possible phase transitions in psychopathology?
   + Give examples. 
* What is the role of destabilization in the treatment of psychopathology?
* Look at the plot of factor 7 for our patient. 
   + Can you visualize a possible phase transition?
   + Do you expect to find early-warning signals in the data of our patient? 
   + Where?

#### Answers {-}


* Can you think of possible phase transitions in psychopathology?
   + Give examples. 

> Onset of pathology (e.g. psychosis), relapse in addiction, suicide attempts, sudden gains and losses, etc.
   
* What is the role of destabilization in the treatment of psychopathology?

> Destabilization is most of the time a good thing in treatment: the goal of treatment is to change (destabilize) the existing state. During destabilization, the patient is increasingly sensitive to external influences (including treatment). Destabilization can be a target period for intervention.

* Look at the plot of factor 7 for our patient. 
   + Can you visualize a possible phase transition?
   
> There is a sudden gain (abrupt and persisting decrease in symptoms) somewhere around day 40.
   
   + Do you expect to find early-warning signals in the data of our patient? 
   + Where?

> Before the sudden gain

### Phase transitions in symptom severity {.tabset .tabset-fade .tabset-pills}

In the last question, you might have hypothesized the occurrence of a phase transition in the impairment by symptoms and problems of our patient (sudden gain). Let's try a method to quantify level shifts, including sudden gains, in time series data.  

#### Questions {-}

* Analyse the time series of factor 7 using the function `ts_levels()` in package `casnet`. 
    + Look at the manual pages to get an idea what is going. 
    + Use this code: 
    
```{r}
library(casnet)
library(ggplot2)
library(tidyr)

ts_levels(df$factor7, minDataSplit = 12, minLevelDuration = 7, changeSensitivity = 0.01, maxLevels=30, method="anova")
```

* Look at the `summary()` of the `tree` field in the output object
    + Look for `primary splits`

*  Plot the results in the `pred` field of the output object (`x` is `time`, `y` is the original series, `p` is the predicted level of the original series.
*  Describe verbally the change trajectory in the symptom severity of our patient. 

#### Answers {-}

* Analyse the time series of factor 7 using the function `ts_levels()` in package `casnet`. 
    + Look at the manual pages to get an idea what is going. 

> This method uses regression trees to quantify segments of the time series. This is OK for descriptive purposes. Ideally, we would classify a phase transition in a qualitative manner (remember, it is a qualitative shift) but the ts_levels function is very useful to identify discontinous shifts in time series data. 

    + Use this code: 

```{r}
library(casnet)
library(ggplot2)
library(tidyr)

(lvl <- ts_levels(df$factor7, minDataSplit = 12, minLevelDuration = 7, changeSensitivity = 0.05, maxLevels=30, method="anova"))
```

* Look at the `summary()` of the `tree` field in the output object

```{r}
summary(lvl$tree)
```

    + Look for `primary splits`

> 39.5 = 40 days

*  Plot the results in the `pred` field of the output object (`x` is `time`, `y` is the original series, `p` is the predicted level of the original series.

```{r}
# ggplot likes the long data format
lvl_long <- lvl$pred %>% 
  gather(key=variable, value=value, -x)

ggplot(lvl_long, aes(x=x, y=value, colour=variable)) + geom_line() + theme_bw()
```

*  Describe verbally the change trajectory in the symptom severity of our patient. 

> Fluctuations around some level then a shift and then fluctuations again, around another level

### Early Warning Signals {.tabset .tabset-fade .tabset-pills}

Now it is time to analyse the dynamic complexity of the ES time series and see if we can find early-warning signals. 

Dynamic complexity can be calculated from short time series of ordered categorical data (see [Schiepek & Strunk, 2010](https://link.springer.com/content/pdf/10.1007%2Fs00422-009-0362-1.pdf)). We can distinguish between different types of fluctuation (see Figure \@ref(fig:dyncomp))

```{r dyncomp, echo=FALSE, fig.cap="Calculation of Dynamic Complexity (F * D) from a Likert scale time series (figure from Schiepek & Strunk (2010)", message=FALSE, warning=FALSE}
knitr::include_graphics("critical_fluctuation.png")
```



#### Questions {-}

* Some questions in the data were answered on a scale from 0 to 100, others from 0 to 6. We must rescale all questions that are 0-100 to the scale 0-6 before we can analyse EWS. 
    + If you like, you can try to write a for loop for this. You can also look at the answers.
* Analyse the dynamic complexity of the ES time series using the function `dyn_comp()`, ask for a plot.
    + The function returns a list, what is in the list?
* Look at the complexity resonance diagram, do you see early-warning signals for the sudden gain?
* Analyse the presence of critical instabilities using the function `crit_in()`, set `doPlot=TRUE`
    + Look at the critical instability diagram, do you see early-warning signals for the sudden gain?
* Plot the time series of the average dynamic complexity of all items 
* Plot the time series of factor 7 and the time series of the average dynamic complexity in one plot
    + You get a warning that there are NA values. Why are there NA's?

#### Answers {-}


* Some questions in the data were answered on a scale from 0 to 100, others from 0 to 6. We must rescale all questions that are 0-100 to the scale 0-6 before we can analyse EWS. 
    + If you like, you can try to write a for loop for this. You can also look at the answers.


```{r}
#  rescale predictors to max=6
for(j in (9:50)){
  if(max(df[,j])>6){
    df[,j] <- elascer(df[,j],mn = 0, mx = 100, lo = 0, hi = 6)
  }
}
```
    
* Analyse the dynamic complexity of the ES time series using the function `dyn_comp()`, ask for a plot.
    + The function returns a list, what is in the list?

```{r}
dc.case <- dyn_comp(df, win=7, col_first=9, col_last=50, scale_min=0, scale_max=6, doPlot = TRUE)
summary(dc.case)
```

> dataframe + plot object

* Look at the complexity resonance diagram, do you see early-warning signals for the sudden gain?

> Yes

* Analyse the presence of critical instabilities using the function `crit_in()`, set `doPlot=TRUE`
    + Look at the critical instability diagram, do you see early-warning signals for the sudden gain?
    
```{r}
ci.case <- crit_in(dc.case$df.comp, 7)
```

* Plot the time series of the average dynamic complexity of all items 

```{r}
dc.mean <- rowMeans(as.matrix(dc.case$df.comp))
plot(dc.mean, type='l')
```   

* Plot the time series of factor 7 and the time series of the average dynamic complexity in one plot

```{r}
library(dplyr)

# Create a long dataset for ggplot
# Here we use the syntax from the `tidyverse` set of packages to create a 
df %>% 
  mutate(MeanDC=ts_standardise(dc.mean)) %>% 
  select(days,factor7,MeanDC) %>% 
  gather(key=variable,value=value,-days) %>%
  ggplot(aes(x=days, y=value, colour=variable)) + geom_line() + theme_bw()
```

    + You get a warning that there are NA values. Why are there NA's?

> Because dynamic complexity is analyzed over a backwards window. The first value is at day 7.



# **Complex Networks**



To complete the network assignments you need to load:
```{r}
library(igraph)
library(qgraph)
library(devtools)
library(casnet)
```

## **Basic graphs**


```{block2,type="rmdnote"}
The following set of assignments serve as a demonstration to get you aquainted with graph models, just follow the instructions.
```


### Plot basic graph types {.tabset .tabset-fade .tabset-pills}

#### Demos {-}

* Create a small ring graph in `igraph` and plot it.

```{r}
g <- graph.ring(20)
plot(g)
```

    + Look in the manual of the `igraph`package for a function that will get you the `degree` of each node (vertex).
    + Also, find a function to get the average path length (mean distcance).


* Create a "Small world" graph and plot it:

```{r}
g_ws <- watts.strogatz.game(1, 20, 5, 0.05)
plot(g_ws)
```

    + Run `degree(g_ws)`, also look at average path length and `transitivity`


*Get a directed scale-free  graph:

```{r}
g_bara <- barabasi.game(20)
plot(g_bara)
```

    - Get the `degree`, `average path length` and `transitivity`
    - There should be a power law relation between nodes number and degree ... (but this is a very small network)

```{r}
# We can add properties to nodes:
V(g_bara)$degree <- degree(g_bara)
get.vertex.attribute(g_bara)

V(g_bara)$name <- 1:20

df.deg <- data.frame(Node=V(g_bara)$name, Degree = V(g_bara)$degree)
df.deg <- df.deg %>% arrange(Degree)

ggplot(df.deg,aes(x=Node,y=Degree)) + geom_point() + stat_smooth(method = "lm") + theme_bw()
```

### Social Networks {.tabset .tabset-fade .tabset-pills}

The package igraph contains data on a Social network of friendships between 34 members of a karate club at a US university in the 1970s.

> See W. W. Zachary, An information flow model for conflict and fission in small groups, *Journal of Anthropological Research 33*, 452-473 (1977).

#### Demos {-}

* Get a graph of the communities within the social network. 

```{r, eval=TRUE}
# Community membership
karate <- graph.famous("Zachary")
wc <- walktrap.community(karate)
plot(wc, karate)
modularity(wc)
membership(wc)
```

    + Check the `igraph` manual, or any on-line source to figure out what the `modularity` and `membership` measures might mean and how they are calculated.


* It is also possible to get the adjacency matrix of the graph

```{r, eval=TRUE}
get.adjacency(karate)
```

    + What do the columns, rows and 0s and 1s stand for?


### Package `qgraph`

Learn about the functionality of the `qgraph` from its author Sacha Epskamp.

Try running the examples, e.g. of the `Big 5`: 

[http://sachaepskamp.com/qgraph/examples](http://sachaepskamp.com/qgraph/examples)


#### `qgraph` tutorials / blog

Great site by Eiko Fried:
[http://psych-networks.com ](http://psych-networks.com )


### Early warning signals

Have a look at the site [Early Warning Systems](http://www.early-warning-signals.org/home/)

There is an accompanying [`R` package `earlywarnings`](https://cran.r-project.org/web/packages/earlywarnings/index.html)
